<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">
    <title>Marker Clustering</title>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

    <link rel="stylesheet" href="google.css">


    <script src="socket.io.js"></script>

</head>

<body>
<div id="map"></div>



<div id="mySidebar" class="sidebar">

</div>


<script>

    function openNav() {
        document.getElementById("mySidebar").style.width = "400px";
    }

    function closeNav() {
        document.getElementById("mySidebar").style.width = "0";
    }


    function elimina_nodi(){
        const myNode = document.getElementById("mySidebar");
        myNode.innerHTML = '';
    }

    function popola_sideBar(array,name) {

        document.getElementById('mySidebar').innerHTML += '<a><h2>'+name+'</h2></a>'

        array.forEach(function (recensione) {


            let stelle = recensione.split("split_stelle")[1];
            console.log(stelle)
            stelle_html=""

            if(stelle==1){
                stelle_html=' <span class="fa fa-star checked">' +    '</span>'+
                            ' <span class="fa fa-star ">' +    '</span>'+
                            ' <span class="fa fa-star ">' +    '</span>'+
                            ' <span class="fa fa-star ">' +    '</span>'+
                            ' <span class="fa fa-star ">' +    '</span>'
            }
            else if(stelle==2){
                stelle_html=' <span class="fa fa-star checked">' +    '</span>'+
                    ' <span class="fa fa-star checked">' +    '</span>'+
                    ' <span class="fa fa-star ">' +    '</span>'+
                    ' <span class="fa fa-star ">' +    '</span>'+
                    ' <span class="fa fa-star ">' +    '</span>'
            }
            else if(stelle==3){
                stelle_html=' <span class="fa fa-star checked">' +    '</span>'+
                    ' <span class="fa fa-star checked">' +    '</span>'+
                    ' <span class="fa fa-star checked">' +    '</span>'+
                    ' <span class="fa fa-star ">' +    '</span>'+
                    ' <span class="fa fa-star ">' +    '</span>'
            }
            else if(stelle==4){
                stelle_html=' <span class="fa fa-star checked">' +    '</span>'+
                    ' <span class="fa fa-star checked">' +    '</span>'+
                    ' <span class="fa fa-star checked">' +    '</span>'+
                    ' <span class="fa fa-star checked">' +    '</span>'+
                    ' <span class="fa fa-star ">' +    '</span>'
            }
            else if(stelle==5){
                stelle_html=' <span class="fa fa-star checked">' +    '</span>'+
                    ' <span class="fa fa-star checked">' +    '</span>'+
                    ' <span class="fa fa-star checked">' +    '</span>'+
                    ' <span class="fa fa-star checked">' +    '</span>'+
                    ' <span class="fa fa-star checked">' +    '</span>'
            }

            console.log(stelle_html)
            document.getElementById('mySidebar').innerHTML +=
            '<a href="javascript:void(0)" class="closebtn" onclick="closeNav()">'+'×'+'</a>'+

                '<a>' + recensione.split("split_testo")[1] +
                    '<br> '+ stelle_html+

                     '<br>' + "recensione scritta il " + recensione.split("split_data")[1].split(" ")[0] + '</br>'+
                    '</br>'+
                '</a>';

        })

    }

/*
    var r = confirm("Clicca su ok finche' compare");
    if (r == true) {
        window.open('/WebstormWorkspace/n_recensioni/index.html', 'barchart', '');
    } else {

    }*/



    var max_markers=15

    // window.open('/WebstormWorkspace/n_recensioni/index.html', 'barchart', '');
    // window.open('/WebstormWorkspace/googlemaps/googlecluster2.html', 'googlemaps', '');


    console.log("avvio")

    var socket = io('http://localhost:3001');

    socket.on('connect', ()=>{
        console.log("connected");
    })

    window.name = "googlemaps";

    var labels = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';

    var markers =[]


    function myfunction(name){
        console.log("cliccato")
       socket.emit('update4',name)
        // window.open('/WebstormWorkspace/n_recensioni/index.html', 'barchart', '');
         window.open('javascript:void window.focus()', 'barchart', '');

    }

    var nome_business;


    function getRandom(){
    var min=0;
    var max=labels.length
    return Math.floor(Math.random() * (+max - +min)) + +min;
    }


    function initMap() {

        var map = new google.maps.Map(document.getElementById('map'), {
            zoom: 4.5,
            center: {lat: 41.159403, lng: -99.625346}
        });


        // Add a marker clusterer to manage the markers.
        var markerCluster = new MarkerClusterer(map, markers,
            {imagePath: 'https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/m'});



        socket.on('update', (data) =>{
            //console.log(data);

            var lat= data.split(",")[0]
            var lng= data.split(",")[1]

            var name= data.split(",")[2]

            var n_recensioni = data.split(",")[3]

            var media_stelle = data.split(",")[4]

            var lista_recensioni= data.split("||||||")[1].split("|||")

            // console.log(name)
            //
            // console.log(lista_recensioni)





            //console.log(lat,lng,name,n_recensioni,media_stelle);

            loc={lat:parseFloat(lat),lng:parseFloat(lng)};

            addMarker(loc,name,n_recensioni,media_stelle,markers,markerCluster,lista_recensioni);


            socket.on('update3', (data) =>{

                trova_marker(markers,data)


            })

        })



        // function myFunction() {
        //     document.getElementById("content").innerHTML = "Hello World";
        // }


        function trova_marker(markers,nome){

            markers.forEach(function (data,i) {

                if(data["title"]==nome){
                    new google.maps.event.trigger( markers[i], 'click' );

                    map.setZoom(15);
                    map.setCenter(markers[i].getPosition());

                }

            })}



        function addMarker(location,name,n_recensioni,media_stelle,markers,markerCluster,lista_recensioni) {


            //se non c'è, se il n di recensioni è maggiore ad almeno 1 elemento, allora aggiungi ed elimina il minimo
            if(isNotIn(markers,location,name,n_recensioni,media_stelle)){

                if(markers.length<max_markers){
                    console.log("aggiunto")

                    let marker = new google.maps.Marker({
                        position: location,
                        label: labels[getRandom()],
                        title: name,
                        customInfo: n_recensioni +"," + media_stelle + "," + location["lat"] + "," + location["lng"]
                    });

                    markers.push(marker);
                    markerCluster.addMarker(marker)


                    var content_window = document.createElement('div'), button,button2;
                    content_window.setAttribute("id","content")


                    content_window.innerHTML =
                        '<div id="siteNotice">'+
                        '</div>'+
                        '<h1 id="firstHeading" class="firstHeading">'+ name +'</h1>'+
                        '<div id="bodyContent">'+
                        '<p> <font size="5"> recensioni: ' + n_recensioni +'</font></p>'+
                        '<p> <font size="5">' + Number((parseFloat(media_stelle)).toFixed(1))+' su 5 stelle </font></p>'
                    '</div>'



                    button = content_window.appendChild(document.createElement('input'));
                    button.type = 'button';
                    button.value = 'vai alla top 15'

                    button2 = content_window.appendChild(document.createElement('input'));
                    button2.type = 'button';
                    button2.value = 'lista recensioni'

                    google.maps.event.addDomListener(button, 'click', function () {
                        myfunction(name);
                    })

                    google.maps.event.addDomListener(button2, 'click', function () {

                        elimina_nodi()

                        popola_sideBar(lista_recensioni,name);
                        openNav();
                    })



                    addInfoWindow(marker, content_window)
                }


                //else if(maggiore_almeno_uno(markers,n_recensioni)){

                else{

                    let marker = new google.maps.Marker({
                        position: location,
                        label: labels[getRandom()],
                        title: name,
                        customInfo: n_recensioni +"," + media_stelle + "," + location["lat"] + "," + location["lng"]
                    });

                    markers.push(marker);

                    //console.log("ho aggiunto -> " + name.toString())


                    // console.log(markers)
                    // console.log("stampo array prima")
                    //
                    // markers.forEach(function (data) {
                    //
                    //     console.log(data["title"],data["customInfo"].split(",")[0])
                    //     }
                    // )
                    //
                    // console.log("fine stampa")


                    formatData(markers)

                    markerCluster.removeMarker(markers[max_markers]) //rimuove il minimo

                    //console.log("rimosso il minimo ->"+ markers[max_markers]["title"].toString())



                    if(markers[max_markers]!=marker){
                    markerCluster.addMarker(marker)
                    }


                    markers.splice(max_markers,1)

                    // console.log(markers)
                    //
                    // console.log("stampo array dopo")
                    //
                    // markers.forEach(function (data) {
                    //
                    //         console.log(data["title"])
                    //     }
                    // )
                    //
                    // console.log("fine stampa")


                    var content_window = document.createElement('div'), button;
                    content_window.setAttribute("id","content")


                    content_window.innerHTML =
                        '<div id="siteNotice">'+
                        '</div>'+
                        '<h1 id="firstHeading" class="firstHeading">'+ name +'</h1>'+
                        '<div id="bodyContent">'+
                        '<p> <font size="5"> recensioni: ' + n_recensioni +'</font></p>'+
                        '<p> <font size="5">' + Number((parseFloat(media_stelle)).toFixed(1))+' su 5 stelle </font></p>'
                    '</div>'



                    button = content_window.appendChild(document.createElement('input'));
                    button.type = 'button';
                    button.value = 'vai alla top 15'

                    button2 = content_window.appendChild(document.createElement('input'));
                    button2.type = 'button';
                    button2.value = 'lista recensioni'

                    google.maps.event.addDomListener(button, 'click', function () {
                        myfunction(name);
                    })

                    google.maps.event.addDomListener(button2, 'click', function () {

                        elimina_nodi()
                        popola_sideBar(lista_recensioni,name);
                        openNav()
                    })



                    addInfoWindow(marker, content_window)}



            }


            update(markers,markerCluster,location,name,n_recensioni,media_stelle,lista_recensioni)

        }

        function addInfoWindow(marker, content_window) {

            var infoWindow = new google.maps.InfoWindow({
                content: content_window,
                maxWidth: 250
            });

            google.maps.event.addListener(marker, 'click', function () {
                infoWindow.open(map, marker);

            });


        }



        function isNotIn(array,location,name,n_recensioni,media_stelle) {
            elementoTrovato= true

            array.forEach(function (data) {

                //se c'è ritorna false
                if ((location["lat"] == data["customInfo"].split(",")[2]) && (location["lng"] == data["customInfo"].split(",")[3])) {
                    elementoTrovato = false
                }}
            )

            return elementoTrovato
        }



        function formatData(data){
            return data.sort(function (a, b) {
                return b["customInfo"].split(",")[0] - a["customInfo"].split(",")[0];
            })

        }


        function update(markers,markerCluster,location,name,n_recensioni,media_stelle,lista_recensioni){

            markers.forEach(function (data,i) {

                //se è stato già aggiunto
                if ((location["lat"] == data["customInfo"].split(",")[2]) && (location["lng"] == data["customInfo"].split(",")[3])) {

                    //se le recensioni sono aumentate c'è un update
                    if(n_recensioni>parseFloat(data["customInfo"].split(",")[0])) {
                        console.log("cambiamento")
                        markerCluster.removeMarker(data)
                        markers.splice(i,1)

                        let marker = new google.maps.Marker({
                            position: location,
                            label: labels[getRandom()],
                            title: name,
                            customInfo: n_recensioni +"," + media_stelle + "," + location["lat"] + "," + location["lng"]
                        });

                        markers.push(marker);

                        var content_window = document.createElement('div'), button;
                        content_window.setAttribute("id","content")


                        content_window.innerHTML =
                            '<div id="siteNotice">'+
                            '</div>'+
                            '<h1 id="firstHeading" class="firstHeading">'+ name +'</h1>'+
                            '<div id="bodyContent">'+
                            '<p> <font size="5"> recensioni: ' + n_recensioni +'</font></p>'+
                            '<p> <font size="5">' + Number((parseFloat(media_stelle)).toFixed(1))+' su 5 stelle </font></p>'
                        '</div>'



                        button = content_window.appendChild(document.createElement('input'));
                        button.type = 'button';
                        button.value = 'vai alla top 15'

                        button2 = content_window.appendChild(document.createElement('input'));
                        button2.type = 'button';
                        button2.value = 'lista recensioni'

                        google.maps.event.addDomListener(button, 'click', function () {
                            myfunction(name);
                        })

                        google.maps.event.addDomListener(button2, 'click', function () {

                            elimina_nodi()
                            popola_sideBar(lista_recensioni,name);
                            openNav();
                        })


                        addInfoWindow(marker,content_window)
                        markerCluster.addMarker(marker)
                    }




                }}
            )


        }


    }


</script>
<script src="https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/markerclusterer.js">
</script>
<script async defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBbilBQ88oVxw2fy2SVBthqqQnMrJG9cgY&callback=initMap">
</script>
</body>
</html>